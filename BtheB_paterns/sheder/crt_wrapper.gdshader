shader_type canvas_item;

uniform float glitch_amount = 0.0;

void fragment() {
    if (glitch_amount <= 0.0) {
        COLOR = texture(TEXTURE, UV);
    } else {
        vec2 uv = UV;
        float glitch = clamp(glitch_amount, 0.0, 1.0);

        // ðŸ”º Ð“Ð»Ñ–Ñ‚Ñ‡-ÑÐ¼ÐµÑ‰ÐµÐ½Ð¸Ñ (Ñ‚Ñ€ÐµÐ¼Ñ‚Ñ–Ð½Ð½Ñ)
        uv.x += sin(UV.y * 1000.0 + TIME * 80.0) * glitch * 0.015;
        uv.y += cos(UV.x * 200.0 + TIME * 60.0) * glitch * 0.007;

        // ðŸ”º Ð¡Ð¸Ð»ÑŒÐ½Ñ–ÑˆÐµ Ð²Ð¸ÐºÑ€Ð¸Ð²Ð»ÐµÐ½Ð½Ñ (Ð»Ñ–Ð½Ð·Ð°)
        uv = uv * 2.0 - 1.0;  // Ð²Ñ–Ð´ [0,1] Ð´Ð¾ [-1,1]
        float actual_curvature = pow(glitch, 1.2) * 0.3;  // Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÐ¸Ð²Ð½Ð° ÐºÑ€Ð¸Ð²Ð¸Ð·Ð½Ð°
        uv *= 1.0 + actual_curvature * (uv.x * uv.x + uv.y * uv.y);
        uv = uv * 0.5 + 0.5;  // Ð½Ð°Ð·Ð°Ð´ Ñƒ [0,1]

        // ðŸ”º Ð¥Ñ€Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð° Ð°Ð±ÐµÑ€Ð°Ñ†Ñ–Ñ
        float aberration = 0.0001 + glitch * 0.003;
        vec4 color;
        color.r = texture(TEXTURE, uv + vec2(aberration, 0.0)).r;
        color.g = texture(TEXTURE, uv).g;
        color.b = texture(TEXTURE, uv - vec2(aberration, 0.0)).b;
        color.a = 1.0;

        // ðŸ”º Ð¡ÐºÐ°Ð½Ð»Ð°Ð¹Ð½Ð¸
        float scanline_intensity = 0.003;
        float scanline = sin(UV.y * 600.0 + TIME * 10.0) * (scanline_intensity + glitch * 0.02);
        color.rgb -= scanline;

        // ðŸ”º Ð’Ñ–Ð½ÑŒÑ”Ñ‚ÐºÐ°
        vec2 vin_uv = UV * 2.0 - 1.0;
        float vignette = smoothstep(1.0, 0.8, length(vin_uv));
        float vignette_mix = mix(1.0, vignette, 0.03 + glitch * 0.25);
        color.rgb *= vignette_mix;

        COLOR = color;
    }
}
